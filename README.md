express-validation [![build status](https://travis-ci.org/AndrewKeig/express-validation.svg)](http://travis-ci.org/AndrewKeig/express-validation)
==================

express-validation is a middleware that validates the `body`, `params`, `query`, `headers` and `cookies` of a request and returns a response with errors; if any of the configured validation rules fail.

## Install
```sh
$ npm install express-validation --save
```

## Difference with express-validator
There is a more star(red) and famous express.js middleware that covers the same use case as this one, they do not overlap at all, as they offer different approaches.

Validat**or** offers an imperative syntax - meaning every check has to be explicitly declared as code, inside a function, middleware in this case, and while it might be comfortable and easier to read the first couple times, it can get clunky in the long run.

Validat**ion** it's strongly based on [Joi][joi], and leverages a declarative syntax. This means developers declare how to handle validation errors, and using Joi syntax to shape the request payloads. API errors tend to be uniform as they are all generated by Joi and handled in your error function.

[joi]: https://github.com/hapijs/joi

# TOC

- [Install](#install)
- [Difference with express-validator](#difference-with-express-validator)
- [Setup](#setup)
- [How to use](#how-to-use)
  + [Request properties and parsing](#request-properties-and-parsing)
  + [Accessing the request context](#accessing-the-request-context)
  + [Working with headers](#working-with-headers)
  + [Distinguish `Error`(s) from `ValidationError`(s)](#distinguish-errors-from-validationerrors)
  + [Options](#options)
  + [Strict schema](#strict-schema)
  + [Specific Status codes and text](#specific-status-codes-and-text)
  + [Global options](#global-options)
  + [Full options list](#full-options-list)
- [Changelog](#changelog)
- [License](#license)
- [Contributors](#contributors)

## Setup
In order to setup and use `express-validation` consider the following simple express application. It has a single route; configured to use the `express-validation` middleware; it accepts as input `validation.login`; which are the validation rules we have defined for this route.

**REQUIRED**: an express error-handler is necessary or your application will throw errors (500).

**file**: [`test/app.js`](test/app.js)
```js
const express      = require('express');
const validate     = require('express-validation');
const http         = require('http');
const bodyParser   = require('body-parser');
const cookieParser = require('cookie-parser');
const app          = express();

app.use(bodyParser.json())
app.use(cookieParser())

app.set('port', 3000);

app.post('/login', validate(validation.login), function(req, res){
  res.json(200);
});

// REQUIRED: error handler for validation errors
app.use(function(err, req, res, next){
  res.status(400).json(err);
});

http.createServer(app);
```


The following section defines our validation rules `validation.login`.  This is simply an object, which uses [https://github.com/spumko/joi](https://github.com/spumko/joi) to define validation rules for a request.

We have defined two rules `email` and `password`.  They are encapsulated inside `body`; which is important; as this defines their location, alternatives being, `params`, `query`, `headers` and `cookies`.

**file**: [`test/validation/login.js`](test/validation/login.js)
```js
const Joi = require('joi');

module.exports = {
  body: {
    email: Joi.string().email().required(),
    password: Joi.string().regex(/[a-zA-Z0-9]{3,30}/).required()
  }
};
```

The following test, calls the route defined in our express application `/login`; it passes in a payload with an `email` and empty `password`.

**file**: [`test/body.js`](test/body.js)
```js
describe('when the request has a missing item in payload', function () {
  it('should return a 400 ok response and a single error', function(done){

    const login = {
        email: "andrew.keig@gmail.com",
        password: ""
    };

    request(app)
      .post('/login')
      .send(login)
      .expect(400)
      .end(function (err, res) {
        const response = JSON.parse(res.text);
        response.errors.length.should.equal(1);
        response.errors[0].messages.length.should.equal(2);
        done();
      });
    });
});
```

Running the above test will produce the following response.

```json
{
  "status": 400,
  "statusText": "Bad Request",
  "errors": [
    {
      "field": "password",
      "location": "body",
      "messages": [
        "the value of password is not allowed to be empty",
        "the value of password must match the regular expression /[a-zA-Z0-9]{3,30}/"
      ],
      "types": [ "any.empty", "string.regex.base" ]
    }
  ]
}
```

Full code for these examples is to be found in [`test/`](test/) directory.

## How to use

### Request properties and parsing
`express-validation` relies on express.js to parse request bodies.  
It's the developer duty to correctly register json parser(s), multipart parser (s), cookie parser(s) and so on.

All declared schema properties needs to be accessible in the request, or they cannot be correctly validated.

### Accessing the request context
Using Joi validation schema it's possible to make references to other properties of the [express.js request](http://expressjs.com/en/4x/api.html#req).

Example:
Validate that the ID in the request params is the same ID as in the body for the endpoint `/context/:id`.

**file**: [`test/validation/context.js`](test/validation/context.js)
```js
const Joi = require('joi');

module.exports = {
  body: {
      id: Joi.string().valid(Joi.ref('$params.id')).required()
  }
};
```

The following test calls the `/context/1` route in the express application; It passes a payload with the an `id` of '2'.

**file**: [`test/context.js`](test/context.js)
```js
  describe('when the schema contains an invalid reference to the request object', function() {
    it('should return a 400 response', function(done) {
      request(app)
        .post('/context/1')
        .send({id: '2'})
        .expect(400)
        .end(function(err, res) {
          if(err) {
            return done(err);
          }
          done();
        });
    });
  });
});
```

Running the above test will produce the following response:

```json
{
  "status": 400,
  "statusText": "Bad Request",
  "errors": [
    {
      "field": "id",
      "location": "body",
      "messages": [
        "\"id\" must be one of [context:params.id]"
      ],
      "types": [
        "any.allowOnly"
      ]
    }
  ]
}
```

### Working with headers
When creating a validation object that checks `req.headers`; please remember to use `lowercase` names; node.js will convert incoming headers to lowercase:

```js
const Joi = require('joi');

module.exports = {
  headers: {
    accesstoken: Joi.string().required(),
    userid : Joi.string().required()
  }
};
```

### Distinguish `Error`(s) from `ValidationError`(s)
`express-validation` invokes express.js `next()` with a `ValidationError` in case of invalid payload.
This let the developer declare complex error handlers, a brief example follows:

```js
const ev = require('express-validation');

// error handler
app.use(function (err, req, res, next) {
  // specific for validation errors
  if (err instanceof ev.ValidationError) return res.status(err.status).json(err);

  // other type of errors, it *might* also be a Runtime Error
  // example handling
  if (process.env.NODE_ENV !== 'production') {
    return res.status(500).send(err.stack);
  } else {
    return res.status(500);
  }
});
```

### Strict schema
By default, additional fields outside of the schema definition will be ignored by validation.  
To enforce strict checking, set the `strict\*` options as follows:

```js
module.exports.post = {
  options: {
    allowUnknownBody: true,
    allowUnknownHeaders: true,
    allowUnknownQuery: true,
    allowUnknownParams: true,
    allowUnknownCookies: true
  },
  ...
};
```

With strict checking enabled, if additional fields gets sent through validation, they will be raise a `ValidationError`.

### Specific Status codes and text
By default, the status code is set to `400`, and status text to `Bad Request`, you can change this behaviour with the following:

```js
module.exports.post = {
  options: {
    status: 422,
    statusText: 'Unprocessable Entity'
  },
  ...
};
```

### Global options
Status code and text can be declared globally.  
At the same time local options will override them.

```js
const ev = require('express-validation');
// assign options
ev.options({
  status: 422,
  statusText: 'Unprocessable Entity'
});

// clear options back to default
ev.options();
```
Thanks to node `require()` caching, all the other `express-validation` instances also have the same set of global options.

### Request mutation
An choice for advanced users can be to enable or disable request mutation.  
It's enabled by default, this means *any* validated property by Joi gets re-assigned to the original request.

Pseudo-code:
```js
function middleware (req, res, next) {
  const validatedBody = Joi.validate(req.body);
  if (mutateRequest) req.body = validatedBody;
  next();
}
```

This can be turned off on a global or per-schema basis.

### Full options list
Recap of all options usable both as global or per-schema basis.

**mutateRequest**: boolean - _default_: `true`  
**allowUnknownBody**: boolean - _default_: `true`  
**allowUnknownHeaders**: boolean - _default_: `true`  
**allowUnknownQuery**: boolean - _default_: `true`  
**allowUnknownParams**: boolean - _default_: `true`  
**allowUnknownCookies**: boolean - _default_: `true`  
**status**: integer - _default_: `400`  
**statusText**: string - _default_: `'Bad Request'`  

A request validation schema can be comprised of the following properties:
```js
module.exports = {
  options: {
    mutateRequest: true,
    allowUnknownBody: true,
    allowUnknownHeaders: true,
    allowUnknownQuery: true,
    allowUnknownParams: true,
    allowUnknownCookies: true,
    status: 400,
    statusText: 'Bad Request',
  },
  body: Joi.array().required(), // Joi schema
  cookies: {...}, // Joi schema
  headers: {...}, // Joi schema
  params: {...}, // Joi schema
  query: {...}, // Joi schema
};
```

Example validation schema(s) can be found in [test/integration/validation/](test/integration/validation/) directory.

## Changelog
Moved to [CHANGELOG.md](https://github.com/AndrewKeig/express-validation/blob/master/CHANGELOG.md)


## License
This work is licensed under the MIT License (see the LICENSE file).

https://github.com/AndrewKeig/express-validation/blob/master/LICENSE

## Contributors
  * Christian Holm https://github.com/holm
  * Iheanyi Ekechukwu https://github.com/iheanyi
  * Aymeric Beaumet https://github.com/aymericbeaumet
  * Valerio Coltrè https://github.com/colthreepv
  * gdw2 https://github.com/gdw2
  * Robert Barbey https://github.com/rbarbey
  * Stefan Lapers https://github.com/slapers
  * Alex Mazzeo https://github.com/amazzeo
